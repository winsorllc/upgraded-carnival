#!/bin/bash
# ClawHub Skill Manager Wrapper
# Provides CLI interface to ClawHub skill registry

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
NPM_GLOBAL_DIR="${NPM_CONFIG_PREFIX:-$HOME/.npm-global}/bin"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

usage() {
    cat << EOF
ClawHub - Skill Registry Manager

Usage: $(basename "$0") <command> [OPTIONS]

Commands:
    search <query>     Search for skills in the registry
    install <name>     Install a skill from the registry
    update [name]      Update installed skill(s)
    publish <path>     Publish a skill to the registry
    list               List installed skills
    info <name>        Show skill information
    login              Authenticate with ClawHub
    whoami             Show current user
    logout             Clear authentication

Options:
    --version VER     Specific version to install/use
    --force            Force update/reinstall
    --all              Update all installed skills

Examples:
    $(basename "$0") search "postgres"
    $(basename "$0") install nano-pdf
    $(basename "$0") update --all
    $(basename "$0") publish ./my-skill

Environment:
    CLAWHUB_TOKEN      Authentication token
    NPM_CONFIG_PREFIX  Where global npm packages are installed

EOF
    exit 1
}

# Find clawhub executable
find_clawhub() {
    # Check in PATH
    if command -v clawhub &> /dev/null; then
        echo "clawhub"
        return
    fi
    
    # Check in npm global
    if [[ -x "${NPM_GLOBAL_DIR}/clawhub" ]]; then
        echo "${NPM_GLOBAL_DIR}/clawhub"
        return
    fi
    
    # Check local node_modules
    if [[ -x "./node_modules/.bin/clawhub" ]]; then
        echo "./node_modules/.bin/clawhub"
        return
    fi
    
    echo ""
}

install_clawhub() {
    echo -e "${YELLOW}ClawHub not found. Installing...${NC}"
    npm install -g clawhub
    
    # Refresh path
    export PATH="${NPM_CONFIG_PREFIX:-$HOME/.npm-global}/bin:$PATH"
}

cmd_search() {
    local query="$1"
    if [[ -z "$query" ]]; then
        echo -e "${RED}Error: search requires a query${NC}" >&2
        exit 1
    fi
    
    echo -e "${CYAN}Searching for: $query${NC}"
    clawhub search "$query"
}

cmd_install() {
    local name="$1"
    local version=""
    local force=""
    
    shift
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --version) version="$2"; shift 2 ;;
            --force|-f) force="--force"; shift ;;
            *) shift ;;
        esac
    done
    
    if [[ -z "$name" ]]; then
        echo -e "${RED}Error: install requires a skill name${NC}" >&2
        exit 1
    fi
    
    local args=("$name")
    [[ -n "$version" ]] && args+=("--version" "$version")
    [[ -n "$force" ]] && args+=("$force")
    
    echo -e "${GREEN}Installing: $name${NC}"
    clawhub install "${args[@]}"
}

cmd_update() {
    local name="$1"
    local all=""
    local force=""
    
    shift
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --all|-a) all="--all"; shift ;;
            --force|-f) force="--force"; shift ;;
            *) shift ;;
        esac
    done
    
    if [[ -n "$all" ]]; then
        echo -e "${GREEN}Updating all skills...${NC}"
        clawhub update --all $force
    elif [[ -z "$name" ]]; then
        echo -e "${RED}Error: specify a skill name or use --all${NC}" >&2
        exit 1
    else
        echo -e "${GREEN}Updating: $name${NC}"
        clawhub update "$name" $force
    fi
}

cmd_publish() {
    local path="$1"
    
    if [[ -z "$path" ]]; then
        echo -e "${RED}Error: publish requires a path${NC}" >&2
        exit 1
    fi
    
    echo -e "${GREEN}Publishing: $path${NC}"
    clawhub publish "$path"
}

cmd_list() {
    clawhub list
}

cmd_info() {
    local name="$1"
    
    if [[ -z "$name" ]]; then
        echo -e "${RED}Error: info requires a skill name${NC}" >&2
        exit 1
    fi
    
    clawhub info "$name"
}

cmd_login() {
    clawhub login
}

cmd_whoami() {
    clawhub whoami
}

cmd_logout() {
    clawhub logout
}

# Main
COMMAND="${1:-}"
[[ "$COMMAND" == "--help" || -z "$COMMAND" ]] && usage

# Check for clawhub
CLAWHUB=$(find_clawhub)
if [[ -z "$CLAWHUB" ]]; then
    install_clawhub
    CLAWHUB=$(find_clawhub)
fi

if [[ -z "$CLAWHUB" ]]; then
    echo -e "${RED}Error: Could not find or install clawhub${NC}" >&2
    exit 1
fi

shift

case "$COMMAND" in
    search) cmd_search "$@" ;;
    install) cmd_install "$@" ;;
    update) cmd_update "$@" ;;
    publish) cmd_publish "$@" ;;
    list) cmd_list ;;
    info) cmd_info "$@" ;;
    login) cmd_login ;;
    whoami) cmd_whoami ;;
    logout) cmd_logout ;;
    *) echo -e "${RED}Unknown command: $COMMAND${NC}" >&2; usage ;;
esac
