#!/bin/bash
# Himalaya Email CLI Wrapper
# Provides interface for managing email via Himalaya

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

usage() {
    cat << EOF
Himalaya Email CLI

Usage: $(basename "$0") <command> [OPTIONS]

Commands:
    list [OPTIONS]      List envelopes (default: INBOX)
    read <id>           Read an envelope by ID
    send [OPTIONS]      Send an email
    delete <id>         Delete an envelope
    folders             List folders for account
    accounts            List configured accounts

List Options:
    --account NAME      Account to use (default: default)
    --folder NAME       Folder to list (default: INBOX)
    --limit N           Number to show (default: 20)
    --output FORMAT     Output format: table, json, rfc

Read Options:
    --plain             Plain text output (no ANSI)

Send Options:
    --from ADDRESS      Sender email
    --to ADDRESS        Recipient email
    --cc ADDRESS        CC recipient
    --bcc ADDRESS       BCC recipient
    --subject TEXT      Email subject
    --body TEXT         Email body
    --body-file FILE    Read body from file
    --attach FILE       Attachment path

Examples:
    $(basename "$0") list --limit 10
    $(basename "$0") read 12345
    $(basename "$0") send --from "me@example.com" --to "you@example.com" --subject "Hi" --body "Hello"
    $(basename "$0") delete 12345

EOF
    exit 1
}

# Check for himalaya
HIMALAYA_CMD=""
if command -v himalaya &> /dev/null; then
    HIMALAYA_CMD="himalaya"
elif [[ -x "${HOME}/.cargo/bin/himalaya" ]]; then
    HIMALAYA_CMD="${HOME}/.cargo/bin/himalaya"
fi

if [[ -z "$HIMALAYA_CMD" ]]; then
    echo -e "${YELLOW}Himalaya not found.${NC}" >&2
    echo "" >&2
    echo "To install, run:" >&2
    echo "  cargo install himalaya" >&2
    echo "" >&2
    echo "Or download from:" >&2
    echo "  https://github.com/soywod/himalaya/releases" >&2
    exit 1
fi

# Parse common options
ACCOUNT=""
FOLDER=""
OUTPUT=""
LIMIT=""

parse_common() {
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --account) ACCOUNT="--account $2"; shift 2 ;;
            --folder) FOLDER="--folder $2"; shift 2 ;;
            --output) OUTPUT="--output $2"; shift 2 ;;
            --limit) LIMIT="--limit $2"; shift 2 ;;
            *) shift ;;
        esac
    done
}

# Main
COMMAND="${1:-}"
[[ "$COMMAND" == "--help" || -z "$COMMAND" ]] && usage

case "$COMMAND" in
    list)
        shift
        parse_common "$@"
        $HIMALAYA_CMD list $ACCOUNT $FOLDER $OUTPUT $LIMIT
        ;;
    read)
        shift
        ID="$1"
        if [[ -z "$ID" ]]; then
            echo -e "${RED}Error: read requires an envelope ID${NC}" >&2
            exit 1
        fi
        $HIMALAYA_CMD read "$ID" --plain
        ;;
    send)
        shift
        # Build send command
        ARGS=()
        while [[ $# -gt 0 ]]; do
            case "$1" in
                --from) ARGS+=("--from" "$2"); shift 2 ;;
                --to) ARGS+=("--to" "$2"); shift 2 ;;
                --cc) ARGS+=("--cc" "$2"); shift 2 ;;
                --bcc) ARGS+=("--bcc" "$2"); shift 2 ;;
                --subject) ARGS+=("--subject" "$2"); shift 2 ;;
                --body) ARGS+=("--body" "$2"); shift 2 ;;
                --body-file) ARGS+=("--body-file" "$2"); shift 2 ;;
                --attach|-a) ARGS+=("--attach" "$2"); shift 2 ;;
                *) shift ;;
            esac
        done
        echo -e "${GREEN}Sending email...${NC}"
        $HIMALAYA_CMD send "${ARGS[@]}"
        echo -e "${GREEN}Email sent${NC}"
        ;;
    delete)
        shift
        ID="$1"
        if [[ -z "$ID" ]]; then
            echo -e "${RED}Error: delete requires an envelope ID${NC}" >&2
            exit 1
        fi
        echo -e "${YELLOW}Deleting envelope $ID...${NC}"
        $HIMALAYA_CMD delete "$ID"
        echo -e "${GREEN}Deleted${NC}"
        ;;
    folders)
        shift
        parse_common "$@"
        $HIMALAYA_CMD envelope folders $ACCOUNT
        ;;
    accounts)
        $HIMALAYA_CMD account list
        ;;
    *)
        echo -e "${RED}Unknown command: $COMMAND${NC}" >&2
        usage
        ;;
esac
