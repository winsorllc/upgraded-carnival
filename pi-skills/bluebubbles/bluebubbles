#!/bin/bash
# BlueBubbles iMessage Integration
# Send and manage iMessages via BlueBubbles server

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CONFIG_FILE="${HOME}/.thepopebot/config.json"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

usage() {
    cat << EOF
BlueBubbles iMessage Integration

Usage: $(basename "$0") <command> [OPTIONS]

Commands:
    send          Send a message
    react         Add tapback reaction
    unsend        Delete a message
    list-chats    List recent conversations

Options:
    --target TEXT       Recipient (phone or email)
    --chat-guid TEXT    Chat GUID (iMessage;+15551234567;123)
    --message TEXT      Message text
    --message-id GUID   Message GUID for reactions/edits
    --emoji EMOJI       Reaction emoji (â¤ï¸ ğŸ˜‚ ğŸ˜® ğŸ˜¢ ğŸ‘ ğŸ‘)
    --attachment FILE   File to attach
    --help              Show this help

Examples:
    $(basename "$0") send --target "+15551234567" --message "Hello"
    $(basename "$0") react --target "+15551234567" --message-id "<guid>" --emoji "ğŸ‘"
    $(basename "$0") unsend --message-id "<guid>"
EOF
    exit 1
}

get_config() {
    local key="$1"
    local default="$2"
    
    if [[ -f "$CONFIG_FILE" ]]; then
        local value
        value=$(grep -o "\"$key\"[[:space:]]*:[[:space:]]*\"[^\"]*\"" "$CONFIG_FILE" 2>/dev/null | sed 's/.*"\([^"]*\)"/\1/')
        if [[ -n "$value" ]]; then
            echo "$value"
            return
        fi
    fi
    
    echo "${!key:-$default}"
}

get_url() {
    get_config "bluebubbles_url" "http://localhost:4567"
}

get_api_key() {
    get_config "bluebubbles_api_key" "${BLUEBUBBLES_API_KEY:-}"
}

api_request() {
    local method="$1"
    local endpoint="$2"
    local data="$3"
    
    local url
    url=$(get_url)
    local api_key
    api_key=$(get_api_key)
    
    if [[ -z "$api_key" ]]; then
        echo -e "${RED}Error: BlueBubbles API key not configured${NC}" >&2
        echo "Set bluebubbles_api_key in $CONFIG_FILE or BLUEBUBBLES_API_KEY env var" >&2
        exit 1
    fi
    
    local curl_args=("-X" "$method" "-H" "Content-Type: application/json")
    
    if [[ -n "$data" ]]; then
        curl_args+=("-d" "$data")
    fi
    
    curl "${curl_args[@]}" "${url}${endpoint}" 2>/dev/null || echo "{}"
}

cmd_send() {
    local target=""
    local chat_guid=""
    local message=""
    local attachment=""
    
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --target) target="$2"; shift 2 ;;
            --chat-guid) chat_guid="$2"; shift 2 ;;
            --message) message="$2"; shift 2 ;;
            --attachment) attachment="$2"; shift 2 ;;
            *) shift ;;
        esac
    done
    
    if [[ -z "$target" && -z "$chat_guid" ]]; then
        echo -e "${RED}Error: --target or --chat-guid required${NC}" >&2
        exit 1
    fi
    
    if [[ -z "$message" && -z "$attachment" ]]; then
        echo -e "${RED}Error: --message or --attachment required${NC}" >&2
        exit 1
    fi
    
    # Build request
    local data
    local endpoint
    
    if [[ -n "$chat_guid" ]]; then
        endpoint="/api/v1/chat/${chat_guid}/message"
        data=$(jq -n \
            --arg text "$message" \
            '{message: {text: $text}}')
    else
        endpoint="/api/v1/message/send"
        data=$(jq -n \
            --arg target "$target" \
            --arg text "$message" \
            '{target: $target, text: $text}')
    fi
    
    echo -e "${GREEN}Sending message...${NC}"
    local response
    response=$(api_request "POST" "$endpoint" "$data")
    
    if echo "$response" | grep -q '"success"'; then
        echo -e "${GREEN}Message sent successfully${NC}"
        echo "$response" | jq -r '.data[0].guid // .message.guid // .' 2>/dev/null || true
    else
        echo -e "${RED}Failed to send message${NC}"
        echo "$response" >&2
        exit 1
    fi
}

cmd_react() {
    local target=""
    local chat_guid=""
    local message_id=""
    local emoji=""
    local remove="false"
    
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --target) target="$2"; shift 2 ;;
            --chat-guid) chat_guid="$2"; shift 2 ;;
            --message-id) message_id="$2"; shift 2 ;;
            --emoji) emoji="$2"; shift 2 ;;
            --remove) remove="true"; shift ;;
            *) shift ;;
        esac
    done
    
    if [[ -z "$message_id" ]]; then
        echo -e "${RED}Error: --message-id required${NC}" >&2
        exit 1
    fi
    
    if [[ -z "$emoji" ]]; then
        echo -e "${RED}Error: --emoji required${NC}" >&2
        exit 1
    fi
    
    local data
    data=$(jq -n \
        --arg guid "$message_id" \
        --arg emoji "$emoji" \
        --argbool remove "$remove" \
        '{messageGuid: $guid, reaction: $emoji, removeReaction: $remove}')
    
    echo -e "${GREEN}Adding reaction...${NC}"
    api_request "POST" "/api/v1/message/react" "$data"
    echo -e "${GREEN}Reaction added${NC}"
}

cmd_unsend() {
    local message_id="$1"
    shift
    
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --message-id) message_id="$2"; shift 2 ;;
            *) shift ;;
        esac
    done
    
    if [[ -z "$message_id" ]]; then
        echo -e "${RED}Error: --message-id required${NC}" >&2
        exit 1
    fi
    
    echo -e "${GREEN}Unsend message...${NC}"
    api_request "DELETE" "/api/v1/message/${message_id}"
    echo -e "${GREEN}Message unsent${NC}"
}

cmd_list() {
    echo -e "${GREEN}Fetching conversations...${NC}"
    local response
    response=$(api_request "GET" "/api/v1/chat?limit=20")
    
    echo "$response" | jq -r '.data[]? | "\(.guid): \(.displayName // .participants[0].address)"' 2>/dev/null || \
        echo "$response"
}

# Main
COMMAND="${1:-}"
[[ "$COMMAND" == "--help" || -z "$COMMAND" ]] && usage

shift

case "$COMMAND" in
    send) cmd_send "$@" ;;
    react) cmd_react "$@" ;;
    unsend) cmd_unsend "$@" ;;
    list-chats) cmd_list ;;
    *) echo -e "${RED}Unknown command: $COMMAND${NC}" >&2; usage ;;
esac
