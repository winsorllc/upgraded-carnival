#!/bin/bash
# System Monitor - Comprehensive health monitoring
set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

usage() {
    cat << EOF
System Monitor - Usage: $(basename "$0") <command> [OPTIONS]
Commands: status, cpu, memory, disk, network, watch, alert
Examples: $(basename "$0") status; $(basename "$0") watch --interval 5
EOF
    exit 1
}

cmd_status() {
    echo -e "${CYAN}=== System Status ===${NC}"
    
    # CPU
    local cpu; cpu=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | cut -d'%' -f1)
    echo -e "CPU: ${cpu:-0}% "
    
    # Memory
    local mem; mem=$(free | grep Mem | awk '{printf "%.1f", $3/$2 * 100}')
    echo -e "Memory: ${mem:-0}%"
    
    # Disk
    local disk; disk=$(df -h / | tail -1 | awk '{print $5}' | tr -d '%')
    echo -e "Disk: ${disk}%"
    
    # Load
    local load; load=$(uptime | awk -F'load average:' '{print $2}' | awk '{print $1}' | tr -d ',')
    echo -e "Load: ${load}"
    
    # Uptime
    local uptime; uptime=$(uptime -p 2>/dev/null || uptime | awk '{print $3,$4}')
    echo -e "Uptime: ${uptime}"
}

cmd_cpu() {
    echo -e "${CYAN}=== CPU Info ===${NC}"
    if command -v lscpu &> /dev/null; then
        lscpu | grep -E "Model name|CPU\(s\)|Thread|Core|Socket"
    fi
    echo ""
    top -bn1 | head -12
}

cmd_memory() {
    echo -e "${CYAN}=== Memory ===${NC}"
    free -h
}

cmd_disk() {
    echo -e "${CYAN}=== Disk Usage ===${NC}"
    df -h | grep -v "tmpfs\|docker\|loop"
}

cmd_network() {
    echo -e "${CYAN}=== Network ===${NC}"
    if command -v ss &> /dev/null; then
        ss -s
    else
        netstat -s 2>/dev/null | head -10
    fi
    echo ""
    ip -br addr show 2>/dev/null || ifconfig
}

cmd_watch() {
    local interval=2
    while [[ "$1" == --* ]]; do
        case "$1" in
            --interval) interval="$2"; shift 2 ;;
            *) shift ;;
        esac
    done
    
    while true; do
        clear
        cmd_status
        sleep "$interval"
    done
}

cmd_alert() {
    local cpu_thresh="" mem_thresh="" disk_thresh=""
    
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --cpu) cpu_thresh="$2"; shift 2 ;;
            --memory) mem_thresh="$2"; shift 2 ;;
            --disk) disk_thresh="$2"; shift 2 ;;
            *) shift ;;
        esac
    done
    
    while true; do
        if [[ -n "$cpu_thresh" ]]; then
            local cpu; cpu=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | cut -d'%' -f1)
            if (( $(echo "$cpu > $cpu_thresh" | bc -l 2>/dev/null || echo 0) )); then
                echo -e "${RED}ALERT: CPU at ${cpu}% (threshold: ${cpu_thresh}%)${NC}"
            fi
        fi
        sleep 60
    done
}

COMMAND="${1:-}"
[[ "$COMMAND" == "--help" || -z "$COMMAND" ]] && usage

case "$COMMAND" in
    status) cmd_status ;;
    cpu) cmd_cpu ;;
    memory) cmd_memory ;;
    disk) cmd_disk ;;
    network) cmd_network ;;
    watch) shift; cmd_watch "$@" ;;
    alert) shift; cmd_alert "$@" ;;
    *) echo "Unknown: $COMMAND"; usage ;;
esac
